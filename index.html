<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner — diag</title>
  <style>
    body{font-family:Arial,sans-serif;padding:1rem;background:#fafafa}
    .box{background:#fff;border:1px solid #eee;padding:1rem;border-radius:8px;max-width:720px;margin:0 auto}
    pre{white-space:pre-wrap;word-break:break-word}
    video{width:100%;max-width:480px;background:#000;border-radius:8px}
    button{margin-top:0.6rem;padding:0.6rem 1rem;border-radius:6px}
  </style>
</head>
<body>
  <div class="box">
    <h2>Диагностика Telegram Web App</h2>
    <p id="hint">Проверяем окружение…</p>

    <h3>Информация окружения</h3>
    <pre id="env"></pre>

    <h3>Telegram.WebApp</h3>
    <pre id="tginfo"></pre>

    <div id="actions"></div>

    <hr/>
    <p>Если вы видите, что <code>tg</code> отсутствует — откройте эту страницу из Telegram, нажав кнопку в боте (InlineKeyboardButton с <code>web_app=WebAppInfo(url)</code>), а не напрямую в браузере.</p>
  </div>

<script>
  function show(id, text){ document.getElementById(id).textContent = text; }

  const ua = navigator.userAgent;
  const origin = location.origin + location.pathname;
  show('env', `URL: ${location.href}\nOrigin: ${origin}\nUser-Agent: ${ua}\nProtocol: ${location.protocol}`);

  const tg = window.Telegram?.WebApp;
  if (!tg) {
    show('tginfo', 'window.Telegram или Telegram.WebApp НЕ найдены.\n\nВозможные причины:\n- Вы открыли страницу в обычном браузере.\n- Страница не была открыта из Telegram кнопки web_app.\n- Вы используете web.telegram.org (может не поддерживать Web App API).\n\nЧто делать:\n1) Откройте бота в мобильном Telegram и нажмите кнопку, которая открывает Web App (InlineKeyboardButton с web_app).\n2) Убедитесь, что URL в кнопке — HTTPS и точный путь до этого файла.\n3) Если тестируете локально, используйте ngrok и HTTPS URL.\n');
    const actions = document.getElementById('actions');
    // Кнопка для копирования URL в буфер обмена (удобно, чтобы открыть в мобильном)
    const btn = document.createElement('button');
    btn.textContent = 'Скопировать URL в буфер (откройте его в Telegram)';
    btn.onclick = () => {
      navigator.clipboard.writeText(location.href).then(()=> {
        alert('URL скопирован. Откройте бот в Telegram и вставьте ссылку в поле сообщения или используйте кнопку web_app.');
      });
    };
    actions.appendChild(btn);
  } else {
    // tg найден — покажем доступные методы
    let info = 'Telegram.WebApp найден!\n';
    info += `isExpanded: ${tg.isExpanded}\n`;
    info += `initData: ${!!tg.initData}\n`;
    info += `version: ${tg.version || 'unknown'}\n`;
    info += `sendData present: ${typeof tg.sendData === 'function'}\n\n`;
    info += 'Вы открыли страницу внутри Telegram. tg.sendData доступен — можно отправлять данные боту.';
    show('tginfo', info);

    // можно показать кнопку закрытия для теста
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Тест: отправить test-data через tg.sendData и закрыть';
    closeBtn.onclick = () => {
      try {
        tg.sendData('test-data-from-webapp');
        alert('Данные отправлены (test-data-from-webapp).');
        setTimeout(()=>tg.close(), 800);
      } catch(e){
        alert('Ошибка при отправке: ' + e.message);
      }
    };
    document.getElementById('actions').appendChild(closeBtn);
  }
</script>
</body>
</html>
