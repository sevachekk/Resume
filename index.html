<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR WebApp — POST to server</title>
  <style>
    body{font-family:system-ui,Arial;padding:16px;background:#071827;color:#eef2f7}
    .box{max-width:720px;margin:0 auto}
    button{padding:10px 12px;border-radius:8px;border:none;background:#2c8f68;color:white}
    .hint{color:#9aa4b2;margin-top:8px}
    pre{background:#0b1220;padding:12px;border-radius:8px;white-space:pre-wrap}
  </style>
</head>
<body>
<div class="box">
  <h1>QR Scanner — POST test</h1>
  <p class="hint">Откройте эту страницу из кнопки бота в мобильном Telegram. После сканирования страница отправит POST на ваш сервер.</p>

  <video id="video" autoplay playsinline style="width:100%;max-height:60vh;background:#000"></video>
  <canvas id="canvas" style="display:none"></canvas>

  <div style="margin-top:8px">
    <button id="start">Запустить камеру</button>
    <button id="stop">Остановить</button>
  </div>

  <div style="margin-top:8px">
    <button id="fakeSend">Тестовый POST (без QR)</button>
  </div>

  <div class="hint">Публичный endpoint, на который будет отправлен POST (замените перед деплоем):</div>
  <pre id="endpoint">https://sevakgrigoryan.vercel.app</pre>

  <div style="margin-top:12px">
    <div>Результат: <span id="result">—</span></div>
    <pre id="debug" style="display:none"></pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
(async function () {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');
  const fakeBtn = document.getElementById('fakeSend');
  const resultEl = document.getElementById('result');
  const debugEl = document.getElementById('debug');

  const ENDPOINT = "https://YOUR_PUBLIC_ENDPOINT/receive"; // <<< ЗАМЕНИТЕ НА ВАШ ngrok URL
  document.getElementById('endpoint').textContent = ENDPOINT;

  let stream = null;
  let scanning = false;
  let lastQr = "";

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      await video.play();
      scanning = true;
      requestAnimationFrame(tick);
    } catch (e) {
      alert("Не удалось получить доступ к камере: " + e.message);
    }
  }

  function stopCamera() {
    scanning = false;
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }

  function tick() {
    if (!scanning) return;
    if (video.readyState !== video.HAVE_ENOUGH_DATA) {
      requestAnimationFrame(tick);
      return;
    }
    const w = video.videoWidth, h = video.videoHeight;
    canvas.width = w; canvas.height = h;
    ctx.drawImage(video, 0, 0, w, h);

    // crop center square
    const side = Math.min(w, h);
    const sx = Math.floor((w - side) / 2);
    const sy = Math.floor((h - side) / 2);
    const imageData = ctx.getImageData(sx, sy, side, side);
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });

    if (code && code.data && code.data !== lastQr) {
      lastQr = code.data;
      resultEl.textContent = code.data;
      // отправляем POST на сервер
      sendPost(code.data);
    }

    requestAnimationFrame(tick);
  }

  async function sendPost(qrText) {
    // Telegram.WebApp.initData — строка, берем её для валидации на сервере
    const tg = window.Telegram?.WebApp;
    const initData = tg?.initData ?? null;

    const payload = { qr: qrText, initData: initData };

    try {
      const resp = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const j = await resp.json();
      debugEl.style.display = 'block';
      debugEl.textContent = JSON.stringify({ status: resp.status, body: j }, null, 2);
      if (resp.ok) {
        console.log("POST ok", j);
      } else {
        console.warn("POST failed", j);
      }
    } catch (e) {
      console.error("sendPost error", e);
      debugEl.style.display = 'block';
      debugEl.textContent = "send error: " + e.message;
    }
  }

  // Тестовая кнопка для отправки без QR
  fakeBtn.addEventListener('click', async () => {
    const tg = window.Telegram?.WebApp;
    const initData = tg?.initData ?? null;
    await sendPost("TEST_QR_123456", initData);
  });

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);

  // автозапуск камеры при загрузке — можно отключить
  // await startCamera();
})();
</script>
</body>
</html>
