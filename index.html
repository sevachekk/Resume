<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WebApp Diagnostic — QR</title>
<style>
  body{font-family:system-ui, -apple-system, Roboto, Arial; padding:12px;}
  pre{background:#f6f8fa;border-radius:6px;padding:8px;white-space:pre-wrap;word-break:break-word;}
  button{margin:6px 6px 6px 0;padding:8px 12px;border-radius:8px;}
</style>
</head>
<body>
  <h3>Diagnostic: Telegram.WebApp</h3>
  <p>Нажмите <b>Show diagnostic</b>, затем скопируйте текст и пришлите сюда.</p>

  <div>
    <button id="show">Show diagnostic</button>
    <button id="copy">Copy to clipboard</button>
    <button id="testSend" style="display:none">Попытаться вызвать tg.sendData("PING")</button>
  </div>

  <pre id="out">Waiting...</pre>

<script>
function getSafe(path, root=window){
  try{ return path.split('.').reduce((o,k)=> o && o[k], root); }catch(e){ return undefined; }
}

document.getElementById('show').addEventListener('click', ()=> {
  const tg = getSafe('Telegram.WebApp', window);
  const hasTelegram = !!getSafe('Telegram', window);
  const hasWebApp = !!tg;
  const hasSendData = !!getSafe('Telegram.WebApp.sendData', window);
  const ua = navigator.userAgent || '';
  const ref = document.referrer || '';
  const topSelf = (window.top === window.self);
  const locationHref = location.href;
  let initData = null;
  try { initData = tg && tg.initData ? tg.initData : null; } catch(e){ initData = "<<error reading initData: "+e+">>"; }

  const info = {
    time: (new Date()).toISOString(),
    userAgent: ua,
    location: locationHref,
    documentReferrer: ref,
    inIframe: !topSelf,
    hasTelegramObject: hasTelegram,
    hasWebAppObject: hasWebApp,
    hasSendData: hasSendData,
    tg_initData_sample: initData ? String(initData).slice(0,200) : null
  };

  const text = JSON.stringify(info, null, 2);
  document.getElementById('out').textContent = text;

  // show test button only if tg exists but sendData missing (for manual testing)
  if (hasWebApp && !hasSendData) {
    document.getElementById('testSend').style.display = 'inline-block';
  } else {
    document.getElementById('testSend').style.display = 'none';
  }
});

document.getElementById('copy').addEventListener('click', async ()=> {
  const txt = document.getElementById('out').textContent;
  try { await navigator.clipboard.writeText(txt); alert('Copied to clipboard'); } catch(e){ alert('Copy failed: '+e); }
});

document.getElementById('testSend').addEventListener('click', ()=> {
  try {
    if (window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.sendData === 'function') {
      window.Telegram.WebApp.sendData('DIAGNOSTIC_PING');
      alert('sendData called');
    } else {
      alert('sendData not available');
    }
  } catch(e){ alert('Error: '+e); }
});
  <!-- кусок JS, вставьте в ваш index.html -->
// Парсим tgWebAppData из location.hash
function parseTgWebAppDataFromHash() {
  const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
  const params = new URLSearchParams(h);
  const raw = params.get('tgWebAppData');
  if (!raw) return null;
  // raw — urlencoded query-string, например "query_id=...&user=%7B...%7D&auth_date=...&hash=..."
  const decoded = decodeURIComponent(raw);
  const q = new URLSearchParams(decoded);
  const out = {};
  for (const [k,v] of q.entries()) out[k] = v;
  // user может быть закодирован несколько раз — попробуем декодировать и распарсить JSON
  if (out.user) {
    try {
      let userStr = out.user;
      // если видим %7B внутри — декодируем ещё раз
      if (userStr.includes('%7B') || userStr.includes('%257B')) userStr = decodeURIComponent(userStr);
      out.user = JSON.parse(userStr);
    } catch(e) {
      console.warn("Can't parse user JSON:", e);
      // оставим оригинал
    }
  }
  return out;
}

// Пример обработчика успешного сканирования (подставьте ваш onScanSuccess)
async function onScanSuccess(scannedText) {
  document.getElementById('output').textContent = "Считано: " + scannedText;

  const init = parseTgWebAppDataFromHash();
  if (!init) {
    alert("Ошибка: нет tgWebAppData в URL. Откройте mini-app через кнопку Web App в чате с ботом.");
    return;
  }

  // Постим на ваш сервер (замените URL на ваш endpoint)
  try {
    const resp = await fetch("https://your-server.example.com/api/webapp/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        init: init,                 // вся структура tgWebAppData: query_id, user, auth_date, hash, signature...
        payload: scannedText        // то, что считали из QR
      })
    });

    const j = await resp.json();
    if (!resp.ok) throw new Error(j.detail || JSON.stringify(j));
    document.getElementById('output').textContent += "\n\nДанные отправлены на сервер.";
  } catch (err) {
    console.error(err);
    alert("Ошибка отправки на сервер: " + err);
  }
}
</script>

</script>
</body>
</html>
