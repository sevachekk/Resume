<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WebApp Diagnostic — QR</title>
<style>
  body{font-family:system-ui, -apple-system, Roboto, Arial; padding:12px;}
  pre{background:#f6f8fa;border-radius:6px;padding:8px;white-space:pre-wrap;word-break:break-word;}
  button{margin:6px 6px 6px 0;padding:8px 12px;border-radius:8px;}
</style>
</head>
<body>
  <h3>Diagnostic: Telegram.WebApp</h3>
  <p>Нажмите <b>Show diagnostic</b>, затем скопируйте текст и пришлите сюда.</p>

  <div>
    <button id="show">Show diagnostic</button>
    <button id="copy">Copy to clipboard</button>
    <button id="testSend" style="display:none">Попытаться вызвать tg.sendData("PING")</button>
  </div>

  <pre id="out">Waiting...</pre>

<script>
function getSafe(path, root=window){
  try{ return path.split('.').reduce((o,k)=> o && o[k], root); }catch(e){ return undefined; }
}

document.getElementById('show').addEventListener('click', ()=> {
  const tg = getSafe('Telegram.WebApp', window);
  const hasTelegram = !!getSafe('Telegram', window);
  const hasWebApp = !!tg;
  const hasSendData = !!getSafe('Telegram.WebApp.sendData', window);
  const ua = navigator.userAgent || '';
  const ref = document.referrer || '';
  const topSelf = (window.top === window.self);
  const locationHref = location.href;
  let initData = null;
  try { initData = tg && tg.initData ? tg.initData : null; } catch(e){ initData = "<<error reading initData: "+e+">>"; }

  const info = {
    time: (new Date()).toISOString(),
    userAgent: ua,
    location: locationHref,
    documentReferrer: ref,
    inIframe: !topSelf,
    hasTelegramObject: hasTelegram,
    hasWebAppObject: hasWebApp,
    hasSendData: hasSendData,
    tg_initData_sample: initData ? String(initData).slice(0,200) : null
  };

  const text = JSON.stringify(info, null, 2);
  document.getElementById('out').textContent = text;

  // show test button only if tg exists but sendData missing (for manual testing)
  if (hasWebApp && !hasSendData) {
    document.getElementById('testSend').style.display = 'inline-block';
  } else {
    document.getElementById('testSend').style.display = 'none';
  }
});

document.getElementById('copy').addEventListener('click', async ()=> {
  const txt = document.getElementById('out').textContent;
  try { await navigator.clipboard.writeText(txt); alert('Copied to clipboard'); } catch(e){ alert('Copy failed: '+e); }
});

document.getElementById('testSend').addEventListener('click', ()=> {
  try {
    if (window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.sendData === 'function') {
      window.Telegram.WebApp.sendData('DIAGNOSTIC_PING');
      alert('sendData called');
    } else {
      alert('sendData not available');
    }
  } catch(e){ alert('Error: '+e); }
});
</script>
</body>
</html>
