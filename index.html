<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner (mini app)</title>
  <style>
    body {{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; padding: 10px; }}
    #reader {{ width: 100%; max-width: 600px; margin: auto; }}
    #result {{ margin-top: 12px; word-break: break-all; }}
    button {{ padding: 8px 12px; border-radius: 8px; border: none; background: #2f9cff; color: white; font-size: 16px; }}
  </style>
</head>
<body>
  <h3>Сканер QR</h3>
  <div id="reader"></div>
  <div id="result">Ожидание сканирования...</div>
  <p>
    <button id="closeBtn">Закрыть</button>
  </p>

  <!-- html5-qrcode (CDN). Для production можно положить локально -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <script>
    (function() {{
      const tg = window.Telegram?.WebApp;
      if (!tg) {{
        document.getElementById("result").innerText = "Ошибка: WebApp API недоступен. Откройте из Telegram.";
      }} else {{
        tg.expand();
      }}

      const resultEl = document.getElementById("result");
      let scanner = null;

      function onScanSuccess(decodedText, decodedResult) {{
        // Показать пользователю
        resultEl.innerText = "Найдено: " + decodedText;
        // Остановить сканер
        if (scanner) {{
          scanner.stop().catch(e => console.warn("stop err", e));
        }}
        // Отправить данные боту (web_app.sendData)
        try {{
          const payload = {{
            qr: decodedText,
            timestamp: Date.now()
          }};
          // sendData отправляет данные в поле message.web_app_data у бота
          tg.sendData(JSON.stringify(payload));
          // можно закрыть webapp, если хочется
          // tg.close();
        }} catch (e) {{
          console.error("sendData error", e);
        }}
      }}

      function onScanFailure(error) {{
        // необязательно логировать каждую ошибку
        // console.warn(`scan fail`);
      }}

      // Инициализация Html5Qrcode
      (async function initScanner() {{
        try {{
          const html5QrCode = new Html5Qrcode("reader");
          scanner = html5QrCode;
          const devices = await Html5Qrcode.getCameras();
          const cameraId = (devices && devices.length) ? devices[0].id : null;
          if (!cameraId) {{
            resultEl.innerText = "Камера не найдена или доступ запрещен.";
            return;
          }}
          const config = {{ fps: 10, qrbox: (window.innerWidth < 400 ? 200 : 300) }};
          await html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure);
          resultEl.innerText = "Сканирование... наведите камеру на QR.";
        }} catch (err) {{
          console.error(err);
          resultEl.innerText = "Ошибка при запуске камеры: " + err;
        }}
      }})();

      document.getElementById("closeBtn").addEventListener("click", function() {{
        if (scanner) {{
          scanner.stop().catch(()=>{{}}).finally(()=>{{ if (tg) tg.close(); }});
        }} else {{
          if (tg) tg.close();
        }}
      }});
    }})();
  </script>
</body>
</html>
