<!-- miniapp.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Scanner (Telegram Web App)</title>
</head>
<body>
  <h3>QR Scanner</h3>
  <video id="video" width="320" height="240" autoplay muted playsinline></video>
  <div id="result"></div>
  <button id="stopBtn">Остановить</button>

  <!-- Библиотека для сканирования (пример CDN) -->
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

  <script>
    // Telegram WebApp API
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand(); // развернуть окно при открытии (опционально)
    }

    const video = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    const stopBtn = document.getElementById('stopBtn');

    // Инициализация сканера (qr-scanner)
    const qrScanner = new QrScanner(video, result => {
      console.log('QR:', result);
      resultDiv.textContent = 'Найдено: ' + result;

      // Отправляем данные боту через Telegram Web App API
      // Это создаст Update у бота с полем message.web_app_data.data = JSON_string
      if (tg && typeof tg.sendData === 'function') {
        tg.sendData(JSON.stringify({ qr: result }));
      } else {
        // Если не в WebApp (например открыли в браузере напрямую), можно отправить на ваш сервер
        fetch('/receive-qr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qr: result })
        }).catch(()=>{});
      }

      // По желанию остановить сканер после первого результата:
      qrScanner.stop();
    });

    // Проверка камеры и запуск
    QrScanner.hasCamera().then(has => {
      if (!has) {
        resultDiv.textContent = 'Камера не найдена';
        return;
      }
      qrScanner.start().catch(err => {
        resultDiv.textContent = 'Не удалось запустить камеру: ' + err;
      });
    });

    stopBtn.addEventListener('click', () => {
      qrScanner.stop();
      if (tg && typeof tg.close === 'function') tg.close(); // можно закрыть WebApp
    });

    // Опционально: показать initData для отладки
    // console.log('initData:', tg?.initData);
  </script>
</body>
</html>
